# Claude Code Instructions for MindScout

## Architecture Documentation Maintenance

### When to Update Architecture Diagrams

**IMPORTANT**: Whenever you make changes to the following, you MUST update `ARCHITECTURE_DIAGRAM.md`:

#### 1. **New Components Added**
- [ ] Added new service/module
- [ ] Added new database table
- [ ] Added new API endpoint
- [ ] Added new MCP tool
- [ ] Added new external API integration

**Action**: Update the "System Overview" diagram and relevant flow diagrams.

#### 2. **Data Flow Changes**
- [ ] Changed how data flows between components
- [ ] Modified API request/response structure
- [ ] Changed database queries
- [ ] Updated recommendation algorithm

**Action**: Update sequence diagrams and flowcharts.

#### 3. **Technology Stack Changes**
- [ ] Added new framework or library
- [ ] Changed database (e.g., SQLite → PostgreSQL)
- [ ] Updated deployment platform
- [ ] Added new development tool

**Action**: Update "Technology Stack" diagram.

#### 4. **Deployment Architecture Changes**
- [ ] Changed cloud provider
- [ ] Added new cloud service
- [ ] Modified scaling strategy
- [ ] Updated CI/CD pipeline

**Action**: Update "GCP Deployment Architecture" and "CI/CD Pipeline" diagrams.

---

## Diagram Update Checklist

When updating architecture, follow this checklist:

### Step 1: Identify Affected Diagrams
```markdown
Which diagrams need updates?
- [ ] System Overview
- [ ] Paper Fetching Flow
- [ ] Semantic Search Flow
- [ ] Recommendation Engine Flow
- [ ] MCP Server Integration
- [ ] Database Schema (ERD)
- [ ] API Endpoints Architecture
- [ ] MCP Tools Mindmap
- [ ] GCP Deployment Architecture
- [ ] CI/CD Pipeline
- [ ] Complete User Journey
- [ ] Component Interaction Matrix
- [ ] Testing Coverage
- [ ] Technology Stack
```

### Step 2: Update Mermaid Code
Open `ARCHITECTURE_DIAGRAM.md` and locate the relevant diagram.

**Example**: If you added a new API endpoint:
```mermaid
# Before
graph LR
    C1[GET /api/articles]
    C2[GET /api/articles/:id]

# After (add new endpoint)
graph LR
    C1[GET /api/articles]
    C2[GET /api/articles/:id]
    C3[POST /api/articles/bulk]  # NEW
```

### Step 3: Verify Rendering
1. Preview in VS Code (with Mermaid extension)
2. Or paste into https://mermaid.live
3. Ensure syntax is correct and diagram renders

### Step 4: Update ARCHITECTURE.md (Text Version)
Update the corresponding text sections in `ARCHITECTURE.md` to match the diagrams.

### Step 5: Commit with Clear Message
```bash
git add ARCHITECTURE_DIAGRAM.md ARCHITECTURE.md
git commit -m "docs: update architecture diagrams - added X component"
```

---

## Common Diagram Patterns

### Adding a New Component

```mermaid
# Pattern for adding to System Overview
subgraph "New Layer Name"
    NEWCOMP[New Component<br/>Description<br/>Details]
end

# Connect to existing components
EXISTING --> NEWCOMP
NEWCOMP --> DATABASE

# Apply consistent styling
style NEWCOMP fill:#YOUR_COLOR
```

### Adding a New API Endpoint

```mermaid
# Add to API Endpoints diagram
C6[POST /api/new-endpoint]
R6[controller.new_function]

C6 --> R6 --> SERVICE
```

### Adding a New Database Table

```mermaid
# Update ERD
NEW_TABLE {
    int id PK
    string field_name
    datetime created_at
}

NEW_TABLE ||--o{ EXISTING_TABLE : "relationship"
```

### Adding a New Flow

```mermaid
# Create sequence diagram
sequenceDiagram
    participant User
    participant Component1
    participant Component2

    User->>Component1: Request
    Component1->>Component2: Process
    Component2-->>User: Response
```

---

## Automated Diagram Validation

### Pre-commit Hook (Optional)

Create `.git/hooks/pre-commit`:

```bash
#!/bin/bash

# Check if ARCHITECTURE_DIAGRAM.md has valid Mermaid syntax
if git diff --cached --name-only | grep -q "ARCHITECTURE_DIAGRAM.md"; then
    echo "Validating Mermaid diagrams..."

    # Install: npm install -g @mermaid-js/mermaid-cli
    if command -v mmdc &> /dev/null; then
        mmdc -i ARCHITECTURE_DIAGRAM.md -o /tmp/test.png 2>&1 | grep -i error
        if [ $? -eq 0 ]; then
            echo "❌ Mermaid syntax errors found!"
            exit 1
        else
            echo "✅ Mermaid diagrams are valid"
        fi
    else
        echo "⚠️  mermaid-cli not installed, skipping validation"
    fi
fi
```

Make it executable:
```bash
chmod +x .git/hooks/pre-commit
```

---

## Quick Reference: Mermaid Syntax

### Graph (System Diagrams)
```mermaid
graph TB
    A[Box] --> B[Another Box]
    B --> C{Decision}
    C -->|Yes| D[Result 1]
    C -->|No| E[Result 2]
```

### Sequence (Interactions)
```mermaid
sequenceDiagram
    A->>B: Request
    B-->>A: Response
    Note over A,B: Important note
```

### Flowchart (Processes)
```mermaid
flowchart TD
    Start([Start]) --> Process[Process]
    Process --> End([End])
```

### ERD (Database)
```mermaid
erDiagram
    TABLE1 ||--o{ TABLE2 : "has many"
    TABLE1 {
        int id PK
        string name
    }
```

### Mindmap (Hierarchies)
```mermaid
mindmap
    root((Root))
        Branch 1
            Leaf 1
            Leaf 2
        Branch 2
```

### Pie Chart (Metrics)
```mermaid
pie title Coverage
    "Module A" : 85
    "Module B" : 60
```

---

## Color Scheme

Use consistent colors across all diagrams:

```
User Interfaces:     #e1f5ff (Light Blue)
Application Layer:   #fff4e1 (Light Yellow)
Data/Services:       #e8f5e9 (Light Green)
External APIs:       #fce4ec (Light Red)
Monitoring:          #f3e5f5 (Light Purple)
Completed/Success:   #4caf50 (Green)
```

Apply in Mermaid:
```mermaid
style ComponentName fill:#e1f5ff
```

---

## Documentation Workflow

### When Adding a New Feature

1. **Design Phase**
   ```bash
   # Create a draft diagram
   # Add to ARCHITECTURE_DIAGRAM.md with [DRAFT] label
   ```

2. **Implementation Phase**
   ```bash
   # Update diagram as you build
   # Keep it in sync with code
   ```

3. **Review Phase**
   ```bash
   # Remove [DRAFT] label
   # Verify all connections are accurate
   # Update related diagrams
   ```

4. **Merge Phase**
   ```bash
   # Include diagram updates in PR
   # Reviewer checks diagram accuracy
   ```

### When Refactoring

1. Mark old components as deprecated in diagram
2. Add new components
3. Show migration path if applicable
4. Update after refactor is complete

---

## Examples of Good Architecture Updates

### Example 1: Adding Redis Caching

**What changed**: Added Redis for API response caching

**Diagrams updated**:
- ✅ System Overview (added Redis component)
- ✅ API Endpoints (added caching layer)
- ✅ GCP Deployment (added Memorystore)
- ✅ Technology Stack (added Redis library)

**Commit message**:
```
docs: add Redis caching to architecture diagrams

- Added Redis component to system overview
- Updated API flow to show cache-aside pattern
- Added Memorystore to GCP deployment diagram
- Updated tech stack
```

### Example 2: Migrating to PostgreSQL

**What changed**: Replaced SQLite with PostgreSQL

**Diagrams updated**:
- ✅ System Overview (DB component updated)
- ✅ GCP Deployment (Cloud SQL instead of local DB)
- ✅ Technology Stack (added psycopg2, removed sqlite3)

**Commit message**:
```
docs: update architecture for PostgreSQL migration

- Changed database component from SQLite to PostgreSQL
- Updated GCP deployment to show Cloud SQL
- Updated connection flow diagrams
- Updated tech stack dependencies
```

---

## Quick Commands

### Preview Diagrams Locally
```bash
# VS Code with extension
code ARCHITECTURE_DIAGRAM.md

# Browser
open https://mermaid.live
# Then paste diagram code
```

### Export to Images
```bash
# Install
npm install -g @mermaid-js/mermaid-cli

# Export single diagram
mmdc -i diagram.md -o diagram.png

# Export with custom theme
mmdc -i diagram.md -o diagram.png -t dark

# Export as SVG (scalable)
mmdc -i diagram.md -o diagram.svg
```

### Validate Syntax
```bash
# Use mermaid.live API
curl -X POST https://mermaid.ink/img/BASE64_ENCODED_DIAGRAM
```

---

## Troubleshooting

### Diagram Not Rendering on GitHub

**Issue**: Mermaid code shows as plain text

**Solution**:
1. Ensure code block starts with ` ```mermaid `
2. No extra spaces before closing ` ``` `
3. Syntax is valid (test on mermaid.live)
4. GitHub sometimes caches - try hard refresh

### Complex Diagrams Too Large

**Issue**: Diagram is unreadable when rendered

**Solution**:
1. Split into multiple smaller diagrams
2. Use subgraphs to organize sections
3. Consider creating a simplified "overview" and detailed "deep-dive" versions

### Syntax Errors

**Issue**: Diagram won't render

**Solution**:
1. Paste into https://mermaid.live for detailed error messages
2. Check for:
   - Missing quotes around labels with spaces
   - Incorrect arrow syntax
   - Unclosed brackets
   - Invalid characters in IDs

---

## Resources

- **Mermaid Live Editor**: https://mermaid.live
- **Mermaid Documentation**: https://mermaid.js.org/intro/
- **GitHub Mermaid Support**: https://github.blog/2022-02-14-include-diagrams-markdown-files-mermaid/
- **Mermaid CLI**: https://github.com/mermaid-js/mermaid-cli

---

## Template for New Diagrams

When adding a completely new diagram:

```markdown
## New Diagram Name

Brief description of what this diagram shows.

```mermaid
graph TB
    %% Add your diagram here
    A[Component A] --> B[Component B]

    %% Apply styling
    style A fill:#e1f5ff
    style B fill:#fff4e1
```

**What it shows**:
- Key point 1
- Key point 2

**When to update**:
- Scenario 1
- Scenario 2
```

---

## Remember

> "The architecture documentation is the source of truth for how the system works. Keep it updated, and future you (and your team) will thank you!"

**Golden Rule**: If you change the code, update the diagrams. If you update the diagrams, ensure they match the code.
