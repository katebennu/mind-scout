#!/bin/bash

# Architecture Documentation Checker
# Reminds developers to update architecture diagrams when relevant files change

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Files that might require architecture updates
ARCH_SENSITIVE_PATTERNS=(
    "backend/main.py"
    "backend/api/"
    "mcp-server/server.py"
    "mindscout/database.py"
    "mindscout/vectorstore.py"
    "mindscout/recommender.py"
    "mindscout/fetchers/"
    "requirements.txt"
    "Dockerfile"
    "cloudbuild.yaml"
)

# Get list of changed files (staged for commit)
CHANGED_FILES=$(git diff --cached --name-only)

# Check if any architecture-sensitive files changed
NEEDS_ARCH_UPDATE=false

for pattern in "${ARCH_SENSITIVE_PATTERNS[@]}"; do
    if echo "$CHANGED_FILES" | grep -q "$pattern"; then
        NEEDS_ARCH_UPDATE=true
        break
    fi
done

# If architecture-sensitive files changed, check if diagrams were updated
if [ "$NEEDS_ARCH_UPDATE" = true ]; then
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Architecture Documentation Check${NC}"
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${YELLOW}You've modified architecture-sensitive files:${NC}"
    echo ""

    for pattern in "${ARCH_SENSITIVE_PATTERNS[@]}"; do
        if echo "$CHANGED_FILES" | grep -q "$pattern"; then
            echo "  üìù $pattern"
        fi
    done

    echo ""

    # Check if architecture docs were also updated
    if echo "$CHANGED_FILES" | grep -q "ARCHITECTURE_DIAGRAM.md"; then
        echo -e "${GREEN}‚úÖ ARCHITECTURE_DIAGRAM.md is included in this commit${NC}"
        echo ""
    else
        echo -e "${RED}‚ùå ARCHITECTURE_DIAGRAM.md was NOT updated${NC}"
        echo ""
        echo -e "${YELLOW}Consider updating the architecture diagrams:${NC}"
        echo ""
        echo "  1. Review .claude/instructions.md for guidance"
        echo "  2. Update relevant diagrams in ARCHITECTURE_DIAGRAM.md"
        echo "  3. Stage the changes: git add ARCHITECTURE_DIAGRAM.md"
        echo ""
        echo -e "${YELLOW}Quick checklist - did you add/change:${NC}"
        echo "  ‚Ä¢ New API endpoint?"
        echo "  ‚Ä¢ New database table?"
        echo "  ‚Ä¢ New service/component?"
        echo "  ‚Ä¢ New MCP tool?"
        echo "  ‚Ä¢ Data flow between components?"
        echo "  ‚Ä¢ External API integration?"
        echo "  ‚Ä¢ Deployment configuration?"
        echo ""
        echo -e "${YELLOW}If yes to any, please update diagrams!${NC}"
        echo ""

        # Ask if user wants to continue anyway
        read -p "Continue commit without updating diagrams? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}Commit cancelled. Please update architecture diagrams.${NC}"
            exit 1
        fi
    fi

    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
fi

# Validate Mermaid syntax if ARCHITECTURE_DIAGRAM.md changed
if echo "$CHANGED_FILES" | grep -q "ARCHITECTURE_DIAGRAM.md"; then
    echo -e "${GREEN}Validating Mermaid diagram syntax...${NC}"

    # Check if mmdc is installed
    if command -v mmdc &> /dev/null; then
        # Try to render the diagram (this validates syntax)
        if mmdc -i ARCHITECTURE_DIAGRAM.md -o /tmp/mindscout_arch_test.png 2>&1 | grep -i "error"; then
            echo -e "${RED}‚ùå Mermaid syntax errors found!${NC}"
            echo ""
            echo "Please fix syntax errors before committing."
            echo "Test your diagrams at: https://mermaid.live"
            exit 1
        else
            echo -e "${GREEN}‚úÖ Mermaid diagrams are syntactically valid${NC}"
            rm -f /tmp/mindscout_arch_test.png
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  mermaid-cli not installed, skipping validation${NC}"
        echo "  Install with: npm install -g @mermaid-js/mermaid-cli"
    fi
fi

echo -e "${GREEN}‚úÖ Architecture documentation check passed${NC}"
exit 0
